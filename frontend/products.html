<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—Ç–∞–ª–æ–≥ –º–µ–±–µ–ª–∏ - –£—é—Ç–Ω—ã–π –î–æ–º</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <header class="school-header">
        <div class="header-container">
            <div class="logo-section">
                <div class="school-logo">
                    <div class="logo-placeholder">ü™ë</div>
                </div>
                <div class="school-titles">
                    <h1 class="school-name">–ú–µ–±–µ–ª—å–Ω—ã–π –º–∞–≥–∞–∑–∏–Ω "–£—é—Ç–Ω—ã–π –î–æ–º"</h1>
                    <p class="school-motto">–°–æ–∑–¥–∞—ë–º —É—é—Ç –≤ –≤–∞—à–µ–º –¥–æ–º–µ —Å 2005 –≥–æ–¥–∞</p>
                </div>
            </div>

            <div class="auth-section">
                <div class="login-form">
                    <input type="text" placeholder="–õ–æ–≥–∏–Ω" id="loginInput">
                    <input type="password" placeholder="–ü–∞—Ä–æ–ª—å" id="passwordInput">
                    <button onclick="handleLogin()">–í–æ–π—Ç–∏</button>
                    <a href="/register" style="margin-top: 8px; text-align: center; display: block; color: white; font-size: 12px; text-decoration: none;">
                        –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                    </a>
                </div>
                <div class="user-view" id="userView" style="display: none;">
                    <span id="userGreeting"></span>
                    <button onclick="handleLogout()">–í—ã–π—Ç–∏</button>
                </div>
                
                <div class="cart-icon">
                    <a href="/cart" class="cart-link">
                        <i class="fas fa-shopping-cart"></i>
                        <span>–ö–æ—Ä–∑–∏–Ω–∞</span>
                        <span class="cart-count" id="cartCount">0</span>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <nav class="main-nav">
        <div class="nav-container">
            <a href="/" class="nav-link active">–ì–ª–∞–≤–Ω–∞—è</a>
            <a href="/products" class="nav-link">–ö–∞—Ç–∞–ª–æ–≥</a>
            <a href="/about" class="nav-link">–û –Ω–∞—Å</a>
            <a href="/contacts" class="nav-link">–ö–æ–Ω—Ç–∞–∫—Ç—ã</a>
        </div>
    </nav>

    <div class="products-page">
        <div class="products-container">
            <div class="products-header">
                <h1>–ö–∞—Ç–∞–ª–æ–≥ –º–µ–±–µ–ª–∏</h1>
                <p>–¢–æ–ª—å–∫–æ —Å–∞–º–∞—è –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –º–µ–±–µ–ª—å –¥–ª—è –≤–∞—à–µ–≥–æ –¥–æ–º–∞</p>
            </div>

            <div class="products-filters">
                <div class="filter-row">
                    <div class="filter-group search-group">
                        <label for="searchInput"><i class="fas fa-search"></i> –ü–æ–∏—Å–∫:</label>
                        <input type="text" id="searchInput" class="filter-select" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞..." style="width: 300px;">
                    </div>
                </div>
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="categoryFilter">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
                        <select id="categoryFilter" class="filter-select">
                            <option value="all">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</option>
                            <option value="–î–∏–≤–∞–Ω—ã">–î–∏–≤–∞–Ω—ã</option>
                            <option value="–ö—Ä–æ–≤–∞—Ç–∏">–ö—Ä–æ–≤–∞—Ç–∏</option>
                            <option value="–°—Ç–æ–ª—ã">–°—Ç–æ–ª—ã</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="sortFilter">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</label>
                        <select id="sortFilter" class="filter-select">
                            <option value="popular">–ü–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏</option>
                            <option value="price-asc">–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é —Ü–µ–Ω—ã</option>
                            <option value="price-desc">–ü–æ —É–±—ã–≤–∞–Ω–∏—é —Ü–µ–Ω—ã</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <button id="resetFiltersBtn" class="reset-filters-btn">
                            <i class="fas fa-undo"></i> –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                        </button>
                    </div>
                </div>
            </div>

            <div class="products-grid" id="productsGrid">
                <!-- –¢–æ–≤–∞—Ä—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
            </div>
        </div>
    </div>

    <footer class="school-footer">
        <div class="footer-container">
            <div class="footer-info">
                <p>&copy; 2025 –ú–µ–±–µ–ª—å–Ω—ã–π –º–∞–≥–∞–∑–∏–Ω "–£—é—Ç–Ω—ã–π –î–æ–º". –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
                <p>–¢–µ–ª–µ—Ñ–æ–Ω: +7 (495) 123-45-67 | Email: info@uytniydom.ru</p>
            </div>
        </div>
    </footer>

    <script src="/static/auth.js"></script>
    <script>
    // ========== –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ö–ê–†–¢–ò–ù–û–ö ==========
    function getProductImage(productId, emoji) {
        // –ú–∞–ø–ø–∏–Ω–≥ ID —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ –ø—É—Ç–∏ –∫ –∫–∞—Ä—Ç–∏–Ω–∫–∞–º
        const imageMap = {
            1: '/static/images/products/divan1.jpg',
            2: '/static/images/products/divan2.jpg',
            3: '/static/images/products/divan3.jpg',
            4: '/static/images/products/divan4.jpg',
            5: '/static/images/products/krovat1.jpg',
            6: '/static/images/products/krovat2.jpg',
            7: '/static/images/products/krovat3.jpg',
            8: '/static/images/products/krovat4.jpg',
            9: '/static/images/products/stol1.jpg',
            10: '/static/images/products/stol2.jpg',
            11: '/static/images/products/stol3.jpg',
            12: '/static/images/products/stol4.jpg'
        };
        
        const imagePath = imageMap[productId];
        if (imagePath) {
            return `<img src="${imagePath}" alt="Product" style="width: 100%; height: 100%; object-fit: cover;">`;
        } else {
            return `<span style="font-size: 4em;">${emoji}</span>`;
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É
    function addToCart(id, name, price, image) {
        let cart = JSON.parse(localStorage.getItem('furnitureCart'));
        if (!cart) cart = { items: [], count: 0, total: 0 };
        
        const existingItem = cart.items.find(item => item.id === id);
        if (existingItem) {
            existingItem.quantity = (existingItem.quantity || 1) + 1;
        } else {
            cart.items.push({ 
                id: id, 
                name: name, 
                price: price, 
                image: image, 
                quantity: 1 
            });
        }
        
        cart.count = cart.items.reduce((sum, item) => sum + (item.quantity || 1), 0);
        cart.total = cart.items.reduce((sum, item) => sum + (item.price * (item.quantity || 1)), 0);
        
        localStorage.setItem('furnitureCart', JSON.stringify(cart));
        document.getElementById('cartCount').textContent = cart.count;
        alert(`‚úÖ "${name}" –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É!`);
    }

    // –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –≤—Å–µ—Ö –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
    let allProducts = [];

    // –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤
    function filterProducts() {
        const searchQuery = document.getElementById('searchInput').value.toLowerCase().trim();
        const category = document.getElementById('categoryFilter').value;
        
        // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –ø–æ–∏—Å–∫—É –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        const filtered = allProducts.filter(product => {
            const matchesSearch = product.name.toLowerCase().includes(searchQuery);
            const matchesCategory = category === 'all' || product.category === category;
            return matchesSearch && matchesCategory;
        });

        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É
        const sortType = document.getElementById('sortFilter').value;
        sortProducts(filtered, sortType);
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã
        displayProducts(filtered);
    }

    // –§—É–Ω–∫—Ü–∏—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
    function sortProducts(products, sortType) {
        switch(sortType) {
            case 'price-asc':
                products.sort((a, b) => a.price - b.price);
                break;
            case 'price-desc':
                products.sort((a, b) => b.price - a.price);
                break;
            case 'popular':
            default:
                // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏ (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ popularity)
                products.sort((a, b) => (b.popularity || 0) - (a.popularity || 0));
                break;
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤
    function displayProducts(products) {
        const grid = document.getElementById('productsGrid');
        grid.innerHTML = '';
        
        if (products.length === 0) {
            grid.innerHTML = '<div style="text-align: center; padding: 50px;">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
            return;
        }
        
        products.forEach(product => {
            const card = document.createElement('div');
            card.className = 'product-card-full';
            card.dataset.category = product.category;
            
            const productImage = getProductImage(product.id, product.image);
            
            card.innerHTML = `
                <div class="product-image-full">
                    ${productImage}
                </div>
                <div class="product-details">
                    <h3 class="product-title">${product.name}</h3>
                    <p class="product-description">${product.description.substring(0, 50)}...</p>
                    <div class="product-price">${product.price.toLocaleString()} ‚ÇΩ</div>
                    <div class="product-meta">
                        <span class="product-category">${product.category}</span>
                        <span class="product-stock">${product.stock}</span>
                    </div>
                    <a href="/product/${product.id}" class="product-details-btn" style="display: block; text-align: center;">
                        <i class="fas fa-info-circle"></i> –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                    </a>
                    <button class="add-to-cart-btn" onclick="addToCart(${product.id}, '${product.name}', ${product.price}, '${product.image}')">
                        <i class="fas fa-cart-plus"></i> –í –∫–æ—Ä–∑–∏–Ω—É
                    </button>
                </div>
            `;
            
            grid.appendChild(card);
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤
    async function loadProducts() {
        console.log("–ó–∞–≥—Ä—É–∂–∞—é —Ç–æ–≤–∞—Ä—ã...");
        
        const category = document.getElementById('categoryFilter').value;
        const url = category === 'all' 
            ? '/api/products' 
            : `/api/products?category=${category}`;
        
        try {
            const response = await fetch(url);
            const data = await response.json();
            
            allProducts = data.products; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ —Ç–æ–≤–∞—Ä—ã
            filterProducts(); // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é
            
            console.log("–¢–æ–≤–∞—Ä—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã:", allProducts.length);
            
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤:", error);
        }
    }

    // –§—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ –≤—Å–µ—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
    function resetFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('categoryFilter').value = 'all';
        document.getElementById('sortFilter').value = 'popular';
        loadProducts(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã
    }

    // Debounce —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞
    function debounce(func, delay) {
        let timeoutId;
        return function (...args) {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => func.apply(this, args), delay);
        };
    }

    // –°–ª—É—à–∞—Ç–µ–ª–∏ —Å–æ–±—ã—Ç–∏–π
    document.getElementById('categoryFilter').addEventListener('change', function() {
        loadProducts(); // –ü—Ä–∏ —Å–º–µ–Ω–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞
    });

    document.getElementById('sortFilter').addEventListener('change', function() {
        filterProducts(); // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –∫ —Ç–µ–∫—É—â–∏–º –¥–∞–Ω–Ω—ã–º
    });

    // –ü–æ–∏—Å–∫ —Å debounce –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è —á–∞—Å—Ç—ã—Ö –≤—ã–∑–æ–≤–æ–≤
    const searchInput = document.getElementById('searchInput');
    searchInput.addEventListener('input', debounce(function() {
        filterProducts();
    }, 300));

    // –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    document.getElementById('resetFiltersBtn').addEventListener('click', resetFilters);

    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    document.addEventListener('DOMContentLoaded', function() {
        console.log("–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞");
        loadProducts();
        
        const savedCart = localStorage.getItem('furnitureCart');
        if (savedCart) {
            const cart = JSON.parse(savedCart);
            document.getElementById('cartCount').textContent = cart.count || 0;
        }
    });
    </script>
    
</body>
</html>